from pptx import Presentation
from pptx.util import Pt
import textwrap
import os

def group_text_into_bullets(text, lines_per_bullet=5):
    """
    Groups text into bullet points, ensuring each bullet contains around 5-6 lines.
    """
    wrapped_text = textwrap.wrap(text, width=100)  # Wrap long sentences
    bullets = []
    buffer = []

    for line in wrapped_text:
        buffer.append(line)
        if len(buffer) >= lines_per_bullet:
            bullets.append("\n".join(buffer))  # Convert to single bullet
            buffer = []

    if buffer:  # Add any remaining text as a final bullet
        bullets.append("\n".join(buffer))

    return bullets

def add_slide(prs, title, bullet_points):
    """
    Adds a slide with a title and grouped bullet points.
    """
    slide_layout = prs.slide_layouts[1]  # Title & Content layout
    slide = prs.slides.add_slide(slide_layout)

    title_shape = slide.shapes.title
    title_shape.text = title
    title_shape.text_frame.paragraphs[0].font.bold = True
    title_shape.text_frame.paragraphs[0].font.size = Pt(28)  # Big readable title

    content_shape = slide.shapes.placeholders[1]
    text_frame = content_shape.text_frame
    text_frame.clear()  # Remove default text

    for bullet in bullet_points:
        p = text_frame.add_paragraph()
        p.text = bullet
        p.font.size = Pt(22)  # Bigger font for readability
        p.space_after = Pt(10)  # Space between bullet points
        p.level = 0  # Keep all at same bullet level

def create_presentation(title, text):
    """
    Generates a PowerPoint presentation with properly formatted bullet points.
    """
    prs = Presentation()  # Create a new blank presentation

    # ✅ Title Slide
    title_slide_layout = prs.slide_layouts[0]
    slide = prs.slides.add_slide(title_slide_layout)
    slide.shapes.title.text = title
    slide.placeholders[1].text = "Generated by AI"

    # ✅ Convert text into grouped bullet points (5-6 lines per bullet)
    bullet_points = group_text_into_bullets(text, lines_per_bullet=5)

    # ✅ Add slides with bullets
    max_bullets_per_slide = 4  # Limit to prevent overcrowding
    current_slide_bullets = []

    for bullet in bullet_points:
        current_slide_bullets.append(bullet)

        if len(current_slide_bullets) >= max_bullets_per_slide:
            add_slide(prs, "Key Points", current_slide_bullets)
            current_slide_bullets = []  # Reset for next slide

    # ✅ Add any remaining bullets
    if current_slide_bullets:
        add_slide(prs, "Additional Information", current_slide_bullets)

    # ✅ Save presentation to a temporary location
    pptx_io = "Generated_Summary_Presentation.pptx"
    prs.save(pptx_io)
    return pptx_io
