from pptx import Presentation
from pptx.util import Inches, Pt
from pptx.enum.text import MSO_AUTO_SIZE, MSO_ANCHOR

def generate_powerpoint(title, text):
    """
    Generate a PowerPoint presentation with proper text margin control
    
    Args:
        title (str): Title for the presentation
        text (str): Content text to be formatted and added to slides
        
    Returns:
        str: Path to the saved PowerPoint file
    """
    # Create presentation
    prs = Presentation()
    
    # Title Slide
    slide_layout = prs.slide_layouts[0]
    slide = prs.slides.add_slide(slide_layout)
    slide.shapes.title.text = title
    slide.placeholders[1].text = "Generated by AI"
    
    # Process text and ensure proper formatting
    formatted_text = format_text_with_bullets(text)
    
    # Add slides with structured bullet points
    max_lines_per_slide = 6  # Prevent overcrowding
    current_slide_text = []
    for line in formatted_text:
        current_slide_text.append(line)
        if len(current_slide_text) >= max_lines_per_slide:
            add_slide_with_margin_control(prs, "Key Points", current_slide_text)
            current_slide_text = []
    
    # Add remaining text
    if current_slide_text:
        add_slide_with_margin_control(prs, "Additional Information", current_slide_text)
    
    # Save presentation
    pptx_io = "/tmp/Generated_Summary_Presentation.pptx"
    prs.save(pptx_io)
    return pptx_io

def format_text_with_bullets(text):
    """
    Format raw text into bullet points
    
    Args:
        text (str): Raw text content
        
    Returns:
        list: List of formatted bullet points
    """
    paragraphs = text.split('\n')
    
    bullet_points = []
    for paragraph in paragraphs:
        if paragraph.strip():
            cleaned = paragraph.strip().lstrip('•-* ')  # Remove any bullet markers
            bullet_points.append(f"• {cleaned}")  # Ensure proper bullet formatting
    
    return bullet_points

def add_slide_with_margin_control(prs, title, bullet_points):
    """
    Add a slide with controlled text margins
    
    Args:
        prs (Presentation): Presentation object
        title (str): Slide title
        bullet_points (list): List of bullet points for this slide
        
    Returns:
        Slide: The newly created slide
    """
    slide_layout = prs.slide_layouts[1]  # Title + Content
    slide = prs.slides.add_slide(slide_layout)
    
    # Set slide title
    slide.shapes.title.text = title
    
    # Get the content placeholder
    content_placeholder = slide.placeholders[1]
    text_frame = content_placeholder.text_frame
    text_frame.clear()  # Remove default text
    
    # **STRICTER MARGINS TO KEEP TEXT INSIDE**
    text_frame.margin_left = Inches(0.4)
    text_frame.margin_right = Inches(0.4)
    text_frame.margin_top = Inches(0.3)
    text_frame.margin_bottom = Inches(0.3)

    # **FORCE TEXT TO FIT & STAY INSIDE BOX**
    text_frame.word_wrap = True
    text_frame.auto_size = MSO_AUTO_SIZE.SHAPE_TO_FIT_TEXT  # Ensures text fits within box
    text_frame.vertical_anchor = MSO_ANCHOR.TOP  # Align text to the top

    # Add bullet points
    for point in bullet_points:
        p = text_frame.add_paragraph()
        p.text = point
        p.level = 0  # First-level bullet
        
        # **TEXT AUTO-SHRINK TO PREVENT OVERFLOW**
        p.space_after = Pt(5)
        font = p.font
        font.size = Pt(20)  # Default font size
        font.bold = False
    
    return slide

# Example usage
if __name__ == "__main__":
    title = "Sample Presentation"
    text = """
    This is the first point about our topic.
    Here is the second important point to consider.
    The third point explains additional details.
    Fourth, we need to consider alternatives.
    Fifth point shows the benefits of our approach.
    Sixth point addresses potential challenges.
    Here are some recommendations based on our findings.
    And finally, next steps to implement our solution.
    """
    
    output_path = generate_powerpoint(title, text)
    print(f"PowerPoint saved to: {output_path}")     
